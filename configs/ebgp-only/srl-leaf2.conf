# Enable BFD on spine-facing links
insert / bfd subinterface ethernet-1/54.0 admin-state enable
insert / bfd subinterface ethernet-1/55.0 admin-state enable
insert / bfd subinterface ethernet-1/56.0 admin-state enable

# Enable LLDP
insert / system lldp interface ethernet-1/54 admin-state enable
insert / system lldp interface ethernet-1/55 admin-state enable
insert / system lldp interface ethernet-1/56 admin-state enable

# Interface setup
## Spine-facing links
insert / interface ethernet-1/54 admin-state enable
## Enable IPv6
insert / interface ethernet-1/54 subinterface 0 ipv6 admin-state enable
## and IPv6 router-advertisements for neighbor discovery
insert / interface ethernet-1/54 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/54 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/54 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/55 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/55 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/55 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/55 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/56 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/56 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/56 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/56 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4

# System (loopback) interface, will be used as the VTEP IP
insert / interface system0 subinterface 0 ipv4 admin-state enable
insert / interface system0 subinterface 0 ipv4 address 10.0.0.2/32

# Routing policies
## Prefix-set for loopback addresses
insert / routing-policy prefix-set loopback-addresses prefix 10.0.0.0/24 mask-length-range 32..32
### Export policy: export loopbacks, and redistribute EVPN and BGP routes we get. Very open.
insert / routing-policy policy export-fabric default-action policy-result reject
insert / routing-policy policy export-fabric statement loopbacks first
insert / routing-policy policy export-fabric statement loopbacks match protocol local
insert / routing-policy policy export-fabric statement loopbacks match prefix prefix-set loopback-addresses
insert / routing-policy policy export-fabric statement loopbacks action policy-result accept
insert / routing-policy policy export-fabric statement accept-bgp after loopbacks
insert / routing-policy policy export-fabric statement accept-bgp match protocol bgp
insert / routing-policy policy export-fabric statement accept-bgp action policy-result accept
insert / routing-policy policy export-fabric statement accept-evpn after accept-bgp
insert / routing-policy policy import-fabric statement accept-evpn match family [ evpn ]
insert / routing-policy policy export-fabric statement accept-evpn action policy-result accept
### Import policy: accept BGP and EVPN routes. Very open.
insert / routing-policy policy import-fabric default-action policy-result reject
insert / routing-policy policy import-fabric statement accept-bgp first
insert / routing-policy policy import-fabric statement accept-bgp match protocol bgp
insert / routing-policy policy import-fabric statement accept-bgp action policy-result accept
insert / routing-policy policy import-fabric statement accept-evpn after accept-bgp
insert / routing-policy policy import-fabric statement accept-evpn match family [ evpn ]
insert / routing-policy policy import-fabric statement accept-evpn action policy-result accept


# Default network instance, this is where the EVPN fabric is built
insert / network-instance default type default
insert / network-instance default admin-state enable
insert / network-instance default description "EVPN fabric"
insert / network-instance default router-id 10.0.0.2
## This is needed for IPv4 over IPv6 next-hops to work. If this is not set, interfaces in this network-instance will discard IPv4 packets, since the IPv4 address family is not configured on the interfaces 
insert / network-instance default ip-forwarding receive-ipv4-check false
## Spine-facing interfaces + loopback
insert / network-instance default interface ethernet-1/54.0
insert / network-instance default interface ethernet-1/55.0
insert / network-instance default interface ethernet-1/56.0
insert / network-instance default interface system0.0
# The main BGP instance. Runs over unnumbered IPv6, carrying IPv4, IPv6 and EVPN address families
insert / network-instance default protocols bgp admin-state enable
## Unique ASN per leaf
insert / network-instance default protocols bgp autonomous-system 65002
insert / network-instance default protocols bgp router-id 10.0.0.2
## Enable IPv4 and EVPN AFIs
insert / network-instance default protocols bgp afi-safi ipv4-unicast admin-state enable
insert / network-instance default protocols bgp afi-safi evpn admin-state enable
## Allow different ASes in the path for multipathing
insert / network-instance default protocols bgp afi-safi ipv4-unicast multipath allow-multiple-as true
insert / network-instance default protocols bgp afi-safi ipv4-unicast multipath ebgp maximum-paths 8
insert / network-instance default protocols bgp afi-safi evpn multipath allow-multiple-as true
insert / network-instance default protocols bgp afi-safi evpn multipath ebgp maximum-paths 8
## Any non-used EVPN routes can still be propagated
insert / network-instance default protocols bgp afi-safi evpn evpn inter-as-vpn true
## Optimizations for rapid withdrawal and advertising in large-scale networks
insert / network-instance default protocols bgp afi-safi ipv4-unicast evpn rapid-update true
insert / network-instance default protocols bgp afi-safi evpn evpn rapid-update true
insert / network-instance default protocols bgp route-advertisement rapid-withdrawal true
insert / network-instance default protocols bgp route-advertisement wait-for-fib-install false

## Peer group for fabric neighbors
insert / network-instance default protocols bgp group fabric admin-state enable
## Import-export policies
insert / network-instance default protocols bgp group fabric export-policy [ export-fabric ] first
insert / network-instance default protocols bgp group fabric import-policy [ import-fabric ] first
## Enable BFD
insert / network-instance default protocols bgp group fabric failure-detection enable-bfd true
insert / network-instance default protocols bgp group fabric failure-detection fast-failover true
insert / network-instance default protocols bgp group fabric afi-safi evpn
## Dynamic BGP neighbors via IPv6 link local addressing
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/54.0 peer-group fabric
## Only allow the spine ASN (65000)
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/54.0 allowed-peer-as [ 65000 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/55.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/55.0 allowed-peer-as [ 65000 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/56.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/56.0 allowed-peer-as [ 65000 ] first


# ----------%< MATCHING CONFIG BETWEEN SRL NODES END %<---------- #


# EVPN L2 multihoming service, VNI 10020 on lag1.0
## ethernet-1/2 is part of lag1
insert / interface ethernet-1/2 ethernet aggregate-id lag1
## LACP LAG with EVPN multihoming
insert / interface lag1 admin-state enable
insert / interface lag1 vlan-tagging true
insert / interface lag1 subinterface 0 type bridged
insert / interface lag1 subinterface 0 admin-state enable
insert / interface lag1 subinterface 0 vlan encap single-tagged vlan-id 20
insert / interface lag1 lag lag-type lacp
insert / interface lag1 lag lacp interval FAST
insert / interface lag1 lag lacp lacp-mode ACTIVE
## The same admin-key, system ID (MAC), system-priority needs to be used everywhere on the leaf side in order for the other side to successfully set up a LAG
insert / interface lag1 lag lacp admin-key 1
insert / interface lag1 lag lacp system-id-mac 00:00:00:00:00:20
insert / interface lag1 lag lacp system-priority 32768
## Create Ethernet segment
insert / system network-instance protocols evpn ethernet-segments bgp-instance 1 ethernet-segment client-evpnmh admin-state enable
## ESI needs to match across all leaf switches too
insert / system network-instance protocols evpn ethernet-segments bgp-instance 1 ethernet-segment client-evpnmh esi 00:24:24:24:24:24:24:00:00:20
## All-active multihoming (all interfaces can forward traffic)
insert / system network-instance protocols evpn ethernet-segments bgp-instance 1 ethernet-segment client-evpnmh multi-homing-mode all-active
## Bind ESI to lag1
insert / system network-instance protocols evpn ethernet-segments bgp-instance 1 ethernet-segment client-evpnmh interface lag1
## Initialize bgp-vpn instance 1 for use
insert / system network-instance protocols bgp-vpn bgp-instance 1
## Bind VNI 10020 to vxlan0.20
insert / tunnel-interface vxlan0 vxlan-interface 20 type bridged
insert / tunnel-interface vxlan0 vxlan-interface 20 ingress vni 10020
## MAC-VRF instance for EVPN L2 Multihoming service
insert / network-instance l2evpn-mh type mac-vrf
insert / network-instance l2evpn-mh admin-state enable
insert / network-instance l2evpn-mh description "EVPN L2 multihoming service"
## Assign interface to network-instance
insert / network-instance l2evpn-mh interface lag1.0
## Assign VXLAN VTEP to network-instance
insert / network-instance l2evpn-mh vxlan-interface vxlan0.20
## Enable advertising EVPN routes in bgp-instance 1
insert / network-instance l2evpn-mh protocols bgp-evpn bgp-instance 1 admin-state enable
insert / network-instance l2evpn-mh protocols bgp-evpn bgp-instance 1 vxlan-interface vxlan0.20
## EVI is set to VNI, but can be set to other value as well
insert / network-instance l2evpn-mh protocols bgp-evpn bgp-instance 1 evi 10020
insert / network-instance l2evpn-mh protocols bgp-evpn bgp-instance 1 ecmp 8
## Set route distinguisher and route targets for this network-instance
insert / network-instance l2evpn-mh protocols bgp-vpn bgp-instance 1 route-distinguisher rd 10.0.0.2:10020
insert / network-instance l2evpn-mh protocols bgp-vpn bgp-instance 1 route-target export-rt target:1:10020
insert / network-instance l2evpn-mh protocols bgp-vpn bgp-instance 1 route-target import-rt target:1:10020


# ethernet-1/1 will carry two services, separated by VLAN tagging
insert / interface ethernet-1/1 vlan-tagging true

## EVPN L3 Route Type 5-only service on ethernet-1/1.100, no MAC-IP routes here, only prefixes!
## Strip VLAN tag 100
insert / interface ethernet-1/1 subinterface 100 vlan encap single-tagged vlan-id 100
## Set up routed subinterface
insert / interface ethernet-1/1 subinterface 100 type routed
insert / interface ethernet-1/1 subinterface 100 ipv4 admin-state enable
insert / interface ethernet-1/1 subinterface 100 ipv4 address 192.168.100.1/31
## This is a routed VXLAN instance
insert / tunnel-interface vxlan0 vxlan-interface 100 type routed
## Bind VNI 10100 to vxlan0.100
insert / tunnel-interface vxlan0 vxlan-interface 100 ingress vni 10100
## IP-VRF instance for EVPN L3 RT5-only service
insert / network-instance l3evpn-rt5only type ip-vrf
insert / network-instance l3evpn-rt5only admin-state enable
insert / network-instance l3evpn-rt5only interface ethernet-1/1.100
insert / network-instance l3evpn-rt5only vxlan-interface vxlan0.100
insert / network-instance l3evpn-rt5only protocols bgp-evpn bgp-instance 1 admin-state enable
insert / network-instance l3evpn-rt5only protocols bgp-evpn bgp-instance 1 vxlan-interface vxlan0.100
insert / network-instance l3evpn-rt5only protocols bgp-evpn bgp-instance 1 evi 10100
insert / network-instance l3evpn-rt5only protocols bgp-evpn bgp-instance 1 ecmp 8
insert / network-instance l3evpn-rt5only protocols bgp-vpn bgp-instance 1 route-distinguisher rd 10.0.0.2:10100
insert / network-instance l3evpn-rt5only protocols bgp-vpn bgp-instance 1 route-target export-rt target:1:10100
insert / network-instance l3evpn-rt5only protocols bgp-vpn bgp-instance 1 route-target import-rt target:1:10100


## EVPN L2 anycast gateway service on ethernet-1/1.200
insert / interface ethernet-1/1 subinterface 200 vlan encap single-tagged vlan-id 200
insert / interface ethernet-1/1 subinterface 200 type bridged
## irb0.200 will host the anycast gateway IP address
insert / interface irb0 subinterface 200 ipv4 admin-state enable
## Set up anycast gateway IP and primary IP as the same IP
insert / interface irb0 subinterface 200 ipv4 address 192.168.200.1/24 anycast-gw true
insert / interface irb0 subinterface 200 ipv4 address 192.168.200.1/24 primary
## Learn from unsolicited ARPs
insert / interface irb0 subinterface 200 ipv4 arp learn-unsolicited true
## Dynamic ARP entries populate the host route table
insert / interface irb0 subinterface 200 ipv4 arp host-route populate dynamic datapath-programming true
## Dynamically learnt entries will be advertised in the EVPN instance
insert / interface irb0 subinterface 200 ipv4 arp evpn advertise dynamic
## Same anycast gateway MAC between leafs
insert / interface irb0 subinterface 200 anycast-gw anycast-gw-mac 00:00:AB:00:01:01

## Bind VNI 10200 to vxlan0.200
insert / tunnel-interface vxlan0 vxlan-interface 200 type bridged
insert / tunnel-interface vxlan0 vxlan-interface 200 ingress vni 10200
## MAC-VRF instance for L2 anycast gateway service
insert / network-instance l2evpn-anycastgw type mac-vrf
insert / network-instance l2evpn-anycastgw interface ethernet-1/1.200
## IRB with anycast gateway address is also assigned to MAC-VRF routing-instance, but could still be assigned to an IP-VRF!
insert / network-instance l2evpn-anycastgw interface irb0.200
insert / network-instance l2evpn-anycastgw vxlan-interface vxlan0.200
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 admin-state enable
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 vxlan-interface vxlan0.200
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 evi 10200
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 ecmp 8
## Advertise MAC-IP routes
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 routes bridge-table mac-ip advertise true
insert / network-instance l2evpn-anycastgw protocols bgp-evpn bgp-instance 1 routes route-table
insert / network-instance l2evpn-anycastgw protocols bgp-vpn bgp-instance 1 route-distinguisher rd 10.0.0.2:10200
insert / network-instance l2evpn-anycastgw protocols bgp-vpn bgp-instance 1 route-target export-rt target:1:10200
insert / network-instance l2evpn-anycastgw protocols bgp-vpn bgp-instance 1 route-target import-rt target:1:10200



