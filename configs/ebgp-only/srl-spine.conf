# Enable BFD on leaf-facing links
insert / bfd subinterface ethernet-1/1.0 admin-state enable
insert / bfd subinterface ethernet-1/2.0 admin-state enable
insert / bfd subinterface ethernet-1/3.0 admin-state enable
insert / bfd subinterface ethernet-1/4.0 admin-state enable
insert / bfd subinterface ethernet-1/5.0 admin-state enable
insert / bfd subinterface ethernet-1/6.0 admin-state enable

# Enable LLDP
insert / system lldp interface ethernet-1/1 admin-state enable
insert / system lldp interface ethernet-1/2 admin-state enable
insert / system lldp interface ethernet-1/3 admin-state enable
insert / system lldp interface ethernet-1/4 admin-state enable
insert / system lldp interface ethernet-1/5 admin-state enable
insert / system lldp interface ethernet-1/6 admin-state enable

# Interface setup
## Leaf-facing links
insert / interface ethernet-1/1 admin-state enable
## Enable IPv6
insert / interface ethernet-1/1 subinterface 0 ipv6 admin-state enable
## and IPv6 router-advertisements for neighbor discovery
insert / interface ethernet-1/1 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/1 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/2 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/2 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/2 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/2 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/2 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/3 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/3 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/3 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/3 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/4 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/4 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/4 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/4 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/5 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/5 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/5 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/5 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4
insert / interface ethernet-1/6 subinterface 0 ipv6 admin-state enable
insert / interface ethernet-1/6 subinterface 0 ipv6 router-advertisement router-role admin-state enable
insert / interface ethernet-1/6 subinterface 0 ipv6 router-advertisement router-role max-advertisement-interval 10
insert / interface ethernet-1/6 subinterface 0 ipv6 router-advertisement router-role min-advertisement-interval 4

# System (loopback) interface
insert / interface system0 subinterface 0 ipv4 admin-state enable
insert / interface system0 subinterface 0 ipv4 address 10.0.0.11/32

# Routing policies
## Prefix-set for loopback addresses
insert / routing-policy prefix-set loopback-addresses prefix 10.0.0.0/24 mask-length-range 32..32
### Export policy: export loopbacks, and redistribute EVPN and BGP routes we get. Very open.
insert / routing-policy policy export-fabric default-action policy-result reject
insert / routing-policy policy export-fabric statement loopbacks first
insert / routing-policy policy export-fabric statement loopbacks match protocol local
insert / routing-policy policy export-fabric statement loopbacks match prefix prefix-set loopback-addresses
insert / routing-policy policy export-fabric statement loopbacks action policy-result accept
insert / routing-policy policy export-fabric statement accept-bgp after loopbacks
insert / routing-policy policy export-fabric statement accept-bgp match protocol bgp
insert / routing-policy policy export-fabric statement accept-bgp action policy-result accept
insert / routing-policy policy export-fabric statement accept-evpn after accept-bgp
insert / routing-policy policy import-fabric statement accept-evpn match family [ evpn ]
insert / routing-policy policy export-fabric statement accept-evpn action policy-result accept
### Import policy: accept BGP and EVPN routes. Very open.
insert / routing-policy policy import-fabric default-action policy-result reject
insert / routing-policy policy import-fabric statement accept-bgp first
insert / routing-policy policy import-fabric statement accept-bgp match protocol bgp
insert / routing-policy policy import-fabric statement accept-bgp action policy-result accept
insert / routing-policy policy import-fabric statement accept-evpn after accept-bgp
insert / routing-policy policy import-fabric statement accept-evpn match family [ evpn ]
insert / routing-policy policy import-fabric statement accept-evpn action policy-result accept


# Default network instance, this is where the EVPN fabric is built
insert / network-instance default type default
insert / network-instance default admin-state enable
insert / network-instance default description "EVPN fabric"
insert / network-instance default router-id 10.0.0.11
## This is needed for IPv4 over IPv6 next-hops to work. If this is not set, interfaces in this network-instance will discard IPv4 packets, since the IPv4 address family is not configured on the interfaces 
insert / network-instance default ip-forwarding receive-ipv4-check false
## Spine-facing interfaces + loopback
insert / network-instance default interface ethernet-1/1.0
insert / network-instance default interface ethernet-1/2.0
insert / network-instance default interface ethernet-1/3.0
insert / network-instance default interface ethernet-1/4.0
insert / network-instance default interface ethernet-1/5.0
insert / network-instance default interface ethernet-1/6.0
insert / network-instance default interface system0.0
# The main BGP instance. Runs over unnumbered IPv6, carrying IPv4, IPv6 and EVPN address families
insert / network-instance default protocols bgp admin-state enable
## Same ASN for every spine - prevents routes where routing goes through two spines
insert / network-instance default protocols bgp autonomous-system 65000
insert / network-instance default protocols bgp router-id 10.0.0.11
## Import-export policies
insert / network-instance default protocols bgp ebgp-default-policy import-reject-all true
insert / network-instance default protocols bgp ebgp-default-policy export-reject-all true
insert / network-instance default protocols bgp export-policy [ export-fabric ] first
insert / network-instance default protocols bgp import-policy [ import-fabric ] first
## Peer group for fabric neighbors
insert / network-instance default protocols bgp group fabric admin-state enable
## Import-export policies
insert / network-instance default protocols bgp group fabric export-policy [ accept-loopbacks ] first
insert / network-instance default protocols bgp group fabric export-policy [ accept-evpn ] after accept-loopbacks
insert / network-instance default protocols bgp group fabric import-policy [ accept-loopbacks ] first
insert / network-instance default protocols bgp group fabric import-policy [ accept-evpn ] after accept-loopbacks
## Enable BFD
insert / network-instance default protocols bgp group fabric failure-detection enable-bfd true
insert / network-instance default protocols bgp group fabric failure-detection fast-failover true
insert / network-instance default protocols bgp group fabric afi-safi evpn

## Dynamic BGP neighbors via IPv6 link local addressing
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/1.0 peer-group fabric
## Allow range of leaf ASNs
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/1.0 allowed-peer-as [ 65001..65534 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/2.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/2.0 allowed-peer-as [ 65001..65534 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/3.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/3.0 allowed-peer-as [ 65001..65534 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/4.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/4.0 allowed-peer-as [ 65001..65534 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/5.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/5.0 allowed-peer-as [ 65001..65534 ] first
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/6.0 peer-group fabric
insert / network-instance default protocols bgp dynamic-neighbors interface ethernet-1/6.0 allowed-peer-as [ 65001..65534 ] first
## Enable EVPN AFI
insert / network-instance default protocols bgp afi-safi evpn admin-state enable
## Allow different ASes in the path for multipathing (for multihoming with unique leaf ASNs)
insert / network-instance default protocols bgp afi-safi evpn multipath allow-multiple-as true
insert / network-instance default protocols bgp afi-safi evpn multipath ebgp maximum-paths 8
## Any non-used EVPN routes can still be propagated
insert / network-instance default protocols bgp afi-safi evpn evpn inter-as-vpn true
## Rapid advertisements, bypassing min-route-advertisement-interval for reachability and withdrawals
insert / network-instance default protocols bgp afi-safi evpn evpn rapid-update true
## Enable IPv4 AFI
insert / network-instance default protocols bgp afi-safi ipv4-unicast admin-state enable
insert / network-instance default protocols bgp afi-safi ipv4-unicast multipath allow-multiple-as true
insert / network-instance default protocols bgp afi-safi ipv4-unicast multipath ebgp maximum-paths 8
## IPv4 over IPv6 next-hops (RFC5549)
insert / network-instance default protocols bgp afi-safi ipv4-unicast ipv4-unicast advertise-ipv6-next-hops true
insert / network-instance default protocols bgp afi-safi ipv4-unicast ipv4-unicast receive-ipv6-next-hops true
## Rapid advertisements, bypassing min-route-advertisement-interval for reachability and withdrawals
insert / network-instance default protocols bgp afi-safi ipv4-unicast evpn rapid-update true
insert / network-instance default protocols bgp afi-safi ipv6-unicast admin-state enable
## Enable IPv6 AFI
insert / network-instance default protocols bgp afi-safi ipv6-unicast multipath allow-multiple-as true
insert / network-instance default protocols bgp afi-safi ipv6-unicast multipath ebgp maximum-paths 8
insert / network-instance default protocols bgp afi-safi ipv6-unicast evpn rapid-update true
## Small optimizations for rapid withdrawal and advertising in large-scale networks
insert / network-instance default protocols bgp route-advertisement rapid-withdrawal true
insert / network-instance default protocols bgp route-advertisement wait-for-fib-install false
